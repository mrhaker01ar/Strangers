<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Strangers - Talk to Random People</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #111;
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }
    video {
      width: 300px;
      margin: 10px;
      border: 2px solid #444;
    }
    #chat {
      max-width: 600px;
      width: 100%;
      margin-top: 20px;
    }
    #messages {
      height: 200px;
      overflow-y: scroll;
      background: #222;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 10px;
    }
    #messageInput {
      width: 80%;
    }
    .filters, .controls {
      margin: 10px;
    }
  </style>
</head>
<body>
  <h1>üë§ Strangers</h1>

  <div class="filters">
    <label>
      Gender:
      <select id="userGender">
        <option value="any">Any</option>
        <option value="male">Male</option>
        <option value="female">Female</option>
      </select>
    </label>
    <label>
      Looking for:
      <select id="lookingFor">
        <option value="any">Any</option>
        <option value="male">Male</option>
        <option value="female">Female</option>
      </select>
    </label>
    <label>
      Region:
      <select id="region">
        <option value="any">Any</option>
        <option value="asia">Asia</option>
        <option value="europe">Europe</option>
        <option value="america">America</option>
      </select>
    </label>
    <button id="startChat">Start Chat</button>
  </div>

  <div class="controls">
    <button onclick="toggleMic()">üé§ Mic On/Off</button>
    <button onclick="toggleCam()">üì∑ Cam On/Off</button>
    <div id="timer"></div>
  </div>

  <video id="localVideo" autoplay muted playsinline></video>
  <video id="remoteVideo" autoplay playsinline></video>

  <div id="chat">
    <div id="messages"></div>
    <input id="messageInput" type="text" placeholder="Say something..." />
    <button onclick="sendMessage()">Send</button>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io('https://strangers-t7wm.onrender.com');
    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');
    const messages = document.getElementById('messages');
    const input = document.getElementById('messageInput');
    let localStream, peer, timerInterval, seconds = 0;
    let audioEnabled = true, videoEnabled = true;

    async function getMedia() {
      localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      localVideo.srcObject = localStream;
    }

    document.getElementById('startChat').onclick = async () => {
      await getMedia();
      const gender = document.getElementById('userGender').value;
      const lookingFor = document.getElementById('lookingFor').value;
      const region = document.getElementById('region').value;
      socket.emit('join', { gender, lookingFor, region });
    };

    socket.on('ready', async () => {
      createPeer();
      localStream.getTracks().forEach(track => peer.addTrack(track, localStream));
      const offer = await peer.createOffer();
      await peer.setLocalDescription(offer);
      socket.emit('offer', offer);
      startTimer();
      appendMessage('Stranger connected.');
    });

    socket.on('offer', async offer => {
      createPeer();
      await peer.setRemoteDescription(new RTCSessionDescription(offer));
      localStream.getTracks().forEach(track => peer.addTrack(track, localStream));
      const answer = await peer.createAnswer();
      await peer.setLocalDescription(answer);
      socket.emit('answer', answer);
      startTimer();
      appendMessage('Stranger connected.');
    });

    socket.on('answer', async answer => {
      await peer.setRemoteDescription(new RTCSessionDescription(answer));
    });

    socket.on('ice-candidate', candidate => {
      peer.addIceCandidate(new RTCIceCandidate(candidate));
    });

    socket.on('chat-message', msg => {
      appendMessage('Stranger: ' + msg);
    });

    socket.on('partner-disconnected', () => {
      appendMessage('Stranger disconnected.');
      clearInterval(timerInterval);
      document.getElementById('timer').textContent = '';
      if (remoteVideo.srcObject) remoteVideo.srcObject.getTracks().forEach(t => t.stop());
      remoteVideo.srcObject = null;
    });

    function sendMessage() {
      const msg = input.value.trim();
      if (!msg) return;
      appendMessage('You: ' + msg);
      socket.emit('chat-message', msg);
      input.value = '';
    }

    input.addEventListener('keypress', e => {
      if (e.key === 'Enter') sendMessage();
    });

    function appendMessage(msg) {
      const div = document.createElement('div');
      div.textContent = msg;
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
    }

    function createPeer() {
      peer = new RTCPeerConnection();
      peer.onicecandidate = e => {
        if (e.candidate) socket.emit('ice-candidate', e.candidate);
      };
      peer.ontrack = e => {
        remoteVideo.srcObject = e.streams[0];
      };
    }

    function toggleMic() {
      if (!localStream) return;
      audioEnabled = !audioEnabled;
      localStream.getAudioTracks().forEach(track => track.enabled = audioEnabled);
    }

    function toggleCam() {
      if (!localStream) return;
      videoEnabled = !videoEnabled;
      localStream.getVideoTracks().forEach(track => track.enabled = videoEnabled);
    }

    function startTimer() {
      clearInterval(timerInterval);
      seconds = 0;
      timerInterval = setInterval(() => {
        seconds++;
        const min = Math.floor(seconds / 60);
        const sec = seconds % 60;
        document.getElementById('timer').textContent = `‚è± Connected: ${min}:${sec < 10 ? '0' : ''}${sec}`;
      }, 1000);
    }
  </script>
</body>
</html>
